<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trip Planner</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 900: '#1e3a8a' }
                    }
                }
            }
        }
    </script>
    
    <style>
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        /* Custom scrollbar for better UX */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 antialiased">

    <div id="app" class="min-h-screen flex flex-col">
        <nav class="bg-white border-b border-gray-200 sticky top-0 z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-16">
                    <div class="flex items-center gap-2 cursor-pointer" @click="currentView = 'dashboard'">
                        <div class="w-8 h-8 bg-brand-600 rounded-lg flex items-center justify-center text-white font-bold">W</div>
                        <span class="font-bold text-xl tracking-tight text-slate-900">WanderLust</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button @click="currentView = 'dashboard'" class="text-gray-500 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">Dashboard</button>
                        <div class="h-8 w-8 rounded-full bg-gray-200 overflow-hidden border border-gray-300">
                            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Felix" alt="User" />
                        </div>
                        <div class="flex gap-2">
                            <button @click="shareTrip" class="px-3 py-1 bg-brand-100 text-brand-700 hover:bg-brand-200 rounded-full text-sm font-medium flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/></svg>
                                Share Trip
                            </button>
     
                            <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">
                                Budget: ${{ activeTripBudget }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <main class="flex-grow max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 w-full">
            
            <div v-if="currentView === 'dashboard'">
                <div class="md:flex md:items-center md:justify-between mb-8">
                    <div>
                        <h1 class="text-3xl font-bold text-slate-900">My Trips</h1>
                        <p class="mt-1 text-sm text-gray-500">Manage your upcoming adventures and past memories.</p>
                    </div>
                    <div class="mt-4 md:mt-0">
                        <button @click="openNewTripModal" class="inline-flex items-center px-4 py-2 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-brand-600 hover:bg-brand-700 transition-colors">
                            <svg class="-ml-1 mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                            New Trip
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 gap-5 sm:grid-cols-3 mb-10">
                    <div class="bg-white overflow-hidden shadow rounded-xl border border-gray-100 p-5">
                        <dt class="text-sm font-medium text-gray-500 truncate">Total Trips</dt>
                        <dd class="mt-1 text-3xl font-semibold text-slate-900">{{ trips.length }}</dd>
                    </div>
                    <div class="bg-white overflow-hidden shadow rounded-xl border border-gray-100 p-5">
                        <dt class="text-sm font-medium text-gray-500 truncate">Upcoming</dt>
                        <dd class="mt-1 text-3xl font-semibold text-brand-600">{{ upcomingTripsCount }}</dd>
                    </div>
                    <div class="bg-white overflow-hidden shadow rounded-xl border border-gray-100 p-5">
                        <dt class="text-sm font-medium text-gray-500 truncate">Total Budget Spent</dt>
                        <dd class="mt-1 text-3xl font-semibold text-slate-900">${{ totalGlobalBudget }}</dd>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div v-for="trip in trips" :key="trip.id" @click="selectTrip(trip)" class="bg-white rounded-xl shadow-sm border border-gray-200 hover:shadow-md transition-shadow cursor-pointer overflow-hidden group">
                        <div class="h-40 bg-gray-200 relative overflow-hidden">
                            <img :src="trip.image" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" alt="Trip">
                            <div class="absolute top-2 right-2 bg-white/90 backdrop-blur px-2 py-1 rounded text-xs font-bold text-gray-700">
                                {{ trip.date }}
                            </div>
                        </div>
                        <div class="p-5">
                            <h3 class="text-lg font-bold text-gray-900">{{ trip.destination }}</h3>
                            <p class="text-sm text-gray-500 mb-4">{{ trip.friends.length }} Friends â€¢ {{ trip.days.length }} Days</p>
                            <div class="flex items-center justify-between">
                                <div class="flex -space-x-2">
                                    <div v-for="(friend, i) in trip.friends.slice(0,3)" :key="i" class="w-8 h-8 rounded-full bg-gray-300 border-2 border-white flex items-center justify-center text-xs overflow-hidden">
                                        <img :src="`https://api.dicebear.com/7.x/avataaars/svg?seed=${friend}`" />
                                    </div>
                                    <div v-if="trip.friends.length > 3" class="w-8 h-8 rounded-full bg-gray-100 border-2 border-white flex items-center justify-center text-xs font-medium text-gray-500">
                                        +{{ trip.friends.length - 3 }}
                                    </div>
                                </div>
                                <span class="text-brand-600 font-medium text-sm">View Details &rarr;</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="currentView === 'details' && activeTrip">
                <div class="mb-6">
                    <button @click="currentView = 'dashboard'" class="mb-2 text-sm text-gray-500 hover:text-brand-600 flex items-center gap-1">
                        &larr; Back to Dashboard
                    </button>
                    <div class="flex flex-col md:flex-row md:items-end justify-between gap-4">
                        <div>
                            <h1 class="text-4xl font-bold text-slate-900">{{ activeTrip.destination }}</h1>
                            <p class="text-gray-500">{{ activeTrip.date }}</p>
                        </div>
                        <div class="flex gap-2">
                             <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">
                                Budget: ${{ activeTripBudget }}
                             </span>
                        </div>
                    </div>
                </div>

                <div class="border-b border-gray-200 mb-6">
                    <nav class="-mb-px flex space-x-8 overflow-x-auto">
                        <button 
                            v-for="tab in ['Schedule', 'Map', 'Expenses', 'Shopping']" 
                            :key="tab"
                            @click="activeTab = tab"
                            :class="[activeTab === tab ? 'border-brand-600 text-brand-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300', 'whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm']"
                        >
                            {{ tab }}
                        </button>
                    </nav>
                </div>

                <div v-if="activeTab === 'Schedule'" class="space-y-6">
                    <div v-for="(day, index) in activeTrip.days" :key="index" class="bg-white border border-gray-200 rounded-xl p-6 shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-gray-900">Day {{ index + 1 }}</h3>
                            <button @click="addActivity(index)" class="text-sm text-brand-600 font-medium hover:underline">+ Add Activity</button>
                        </div>
                        <div class="relative border-l-2 border-gray-100 ml-3 space-y-6">
                            <div v-for="(activity, aIndex) in day.activities" :key="aIndex" class="ml-6 relative">
                                <div class="absolute -left-[31px] bg-white border-2 border-brand-500 rounded-full w-4 h-4"></div>
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-semibold text-gray-900">{{ activity.time }} - {{ activity.title }}</p>
                                        <p class="text-sm text-gray-500">{{ activity.location }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="activeTab === 'Map'" class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden h-[500px]">
                    <iframe 
                        width="100%" 
                        height="100%" 
                        frameborder="0" 
                        scrolling="no" 
                        marginheight="0" 
                        marginwidth="0" 
                        :src="`https://maps.google.com/maps?q=${activeTrip.destination}&t=&z=13&ie=UTF8&iwloc=&output=embed`">
                    </iframe>
                </div>

                <div v-if="activeTab === 'Expenses'" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 space-y-6">
                        <div class="bg-white p-5 rounded-xl border border-gray-200 shadow-sm">
                            <h3 class="font-bold text-lg mb-4">Add Expense</h3>
                            <form @submit.prevent="addExpense" class="space-y-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-700">Description</label>
                                    <input v-model="newExpense.desc" type="text" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 sm:text-sm border p-2">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700">Amount ($)</label>
                                    <input v-model.number="newExpense.amount" type="number" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 sm:text-sm border p-2">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-700">Paid By</label>
                                    <select v-model="newExpense.payer" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 sm:text-sm border p-2">
                                        <option v-for="friend in activeTrip.friends" :value="friend">{{ friend }}</option>
                                    </select>
                                </div>
                                <button type="submit" class="w-full bg-brand-600 text-white py-2 rounded-md hover:bg-brand-700 font-medium text-sm">Add Expense</button>
                            </form>
                        </div>

                        <div class="bg-blue-50 p-5 rounded-xl border border-blue-100">
                            <h3 class="font-bold text-brand-900 mb-2">Split Summary</h3>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-brand-800">Total Cost:</span>
                                <span class="font-bold text-lg text-brand-900">${{ activeTripBudget }}</span>
                            </div>
                            <div class="flex justify-between items-center border-t border-blue-200 pt-2">
                                <span class="text-sm text-brand-800">Per Person ({{ activeTrip.friends.length }}):</span>
                                <span class="font-bold text-lg text-brand-900">${{ splitAmount }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="lg:col-span-2 bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Paid By</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                    <th class="px-6 py-3"></th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <tr v-for="(expense, i) in activeTrip.expenses" :key="i">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ expense.desc }}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ expense.payer }}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 text-right">${{ expense.amount }}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <button @click="removeExpense(i)" class="text-red-600 hover:text-red-900">Delete</button>
                                    </td>
                                </tr>
                                <tr v-if="activeTrip.expenses.length === 0">
                                    <td colspan="4" class="px-6 py-10 text-center text-gray-500 italic">No expenses added yet.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div v-if="activeTab === 'Shopping'" class="max-w-2xl mx-auto">
                    <div class="bg-white shadow rounded-xl border border-gray-200 overflow-hidden">
                        <div class="p-4 bg-gray-50 border-b border-gray-200 flex gap-2">
                            <input v-model="newItem" @keyup.enter="addItem" type="text" placeholder="Add item (e.g., Sunscreen, Passport)..." class="flex-1 rounded-md border-gray-300 shadow-sm focus:border-brand-500 focus:ring-brand-500 sm:text-sm border p-2">
                            <button @click="addItem" class="bg-brand-600 text-white px-4 py-2 rounded-md hover:bg-brand-700 text-sm font-medium">Add</button>
                        </div>
                        <ul class="divide-y divide-gray-200">
                            <li v-for="(item, i) in activeTrip.shoppingList" :key="i" class="p-4 flex items-center hover:bg-gray-50 transition-colors">
                                <input type="checkbox" v-model="item.checked" class="h-4 w-4 text-brand-600 focus:ring-brand-500 border-gray-300 rounded">
                                <span :class="{'line-through text-gray-400': item.checked, 'text-gray-900': !item.checked}" class="ml-3 flex-1">{{ item.text }}</span>
                                <button @click="removeItem(i)" class="text-gray-400 hover:text-red-500 text-sm">Remove</button>
                            </li>
                            <li v-if="activeTrip.shoppingList.length === 0" class="p-8 text-center text-gray-500">
                                Your list is empty. Start adding items!
                            </li>
                        </ul>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script type="module">
    // 1. Import Vue and Firebase from CDNs
    import { createApp, ref, reactive, computed, onMounted, watch } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, getDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    // Firebase configuration
    const firebaseConfig = {
    apiKey: "AIzaSyCncLyF2NlitEyz3QJ4qBMQAfAZXAH9GJo",
    authDomain: "trip-planner-52351.firebaseapp.com",
    projectId: "trip-planner-52351",
    storageBucket: "trip-planner-52351.firebasestorage.app",
    messagingSenderId: "11881619143",
    appId: "1:11881619143:web:1f69ee5ff1573eab9f68e2",
    measurementId: "G-Q28K2KS7B1"
    }

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    createApp({
        setup() {
            // State
            const currentView = ref('dashboard');
            const activeTab = ref('Schedule');
            const trips = ref([]); // Now empty, will load from Cloud
            const activeTrip = ref(null);
            
            // Forms
            const newExpense = reactive({ desc: '', amount: '', payer: '' });
            const newItem = ref('');

            // --- COMPUTED PROPERTIES ---
            const upcomingTripsCount = computed(() => trips.value.length);
            
            const totalGlobalBudget = computed(() => {
                return trips.value.reduce((acc, trip) => {
                    return acc + (trip.expenses || []).reduce((sum, e) => sum + e.amount, 0);
                }, 0);
            });

            const activeTripBudget = computed(() => {
                if(!activeTrip.value || !activeTrip.value.expenses) return 0;
                return activeTrip.value.expenses.reduce((sum, e) => sum + e.amount, 0);
            });

            const splitAmount = computed(() => {
                if(!activeTrip.value || !activeTrip.value.friends || activeTrip.value.friends.length === 0) return 0;
                return (activeTripBudget.value / activeTrip.value.friends.length).toFixed(2);
            });

            // --- DATABASE FUNCTIONS ---

            // 1. Load all trips (Real-time Listener)
            const loadTrips = () => {
                // Listens for updates. If a friend changes data, this runs automatically.
                onSnapshot(collection(db, "trips"), (snapshot) => {
                    trips.value = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                });
            };

            // 2. Create a New Trip
            const createTrip = async () => {
                const dest = prompt("Where are you going?");
                if (!dest) return;

                const newTrip = {
                    destination: dest,
                    date: 'Upcoming',
                    image: 'https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?q=80&w=1000&auto=format&fit=crop',
                    friends: ['You'],
                    expenses: [],
                    shoppingList: [],
                    days: [{ activities: [] }]
                };

                // Save to Cloud
                try {
                    const docRef = await addDoc(collection(db, "trips"), newTrip);
                    alert("Trip created! ID: " + docRef.id);
                } catch (e) {
                    console.error("Error adding trip: ", e);
                    alert("Error saving to database. Check your API Keys.");
                }
            };

            // 3. Save Changes (Updates the entire trip object)
            // In a real app, you'd update specific fields, but this is easier for now.
            const saveActiveTrip = async () => {
                if (!activeTrip.value) return;
                const tripRef = doc(db, "trips", activeTrip.value.id);
                await updateDoc(tripRef, { ...activeTrip.value });
            };

            // 4. Share Feature
            const shareTrip = () => {
                if (!activeTrip.value) return;
                const url = window.location.origin + window.location.pathname + "?trip_id=" + activeTrip.value.id;
                navigator.clipboard.writeText(url);
                alert("Link copied! Send this to your friends:\n" + url);
            };

            // --- APP LOGIC ---

            const selectTrip = (trip) => {
                activeTrip.value = trip;
                currentView.value = 'details';
                activeTab.value = 'Schedule';
                if(trip.friends.length > 0) newExpense.payer = trip.friends[0];
            };

            // Watch for changes in the active trip and auto-save to cloud
            // This is "Auto-Save" mode
            watch(activeTrip, (newVal) => {
                if(newVal) {
                    // Debounce could be added here to prevent too many writes
                    saveActiveTrip(); 
                }
            }, { deep: true });


            // Helper: Add Expense
            const addExpense = () => {
                if(!newExpense.desc || !newExpense.amount) return;
                if(!activeTrip.value.expenses) activeTrip.value.expenses = [];
                
                activeTrip.value.expenses.push({
                    desc: newExpense.desc,
                    amount: parseFloat(newExpense.amount),
                    payer: newExpense.payer
                });
                newExpense.desc = ''; newExpense.amount = '';
            };

            const removeExpense = (index) => {
                activeTrip.value.expenses.splice(index, 1);
            };

            // Helper: Shopping List
            const addItem = () => {
                if(!newItem.value) return;
                if(!activeTrip.value.shoppingList) activeTrip.value.shoppingList = [];
                activeTrip.value.shoppingList.push({ text: newItem.value, checked: false });
                newItem.value = '';
            };

            const removeItem = (index) => {
                activeTrip.value.shoppingList.splice(index, 1);
            };

            // Helper: Schedule
            const addActivity = (dayIndex) => {
                const title = prompt("Activity Title:");
                if(title) {
                    activeTrip.value.days[dayIndex].activities.push({
                        time: '12:00 PM', title: title, location: 'TBD'
                    });
                }
            };

            const removeActivity = (dayIndex, activityIndex) => {
                activeTrip.value.days[dayIndex].activities.splice(activityIndex, 1);
            };


            // --- INITIALIZATION ---
            onMounted(async () => {
                loadTrips();

                // Check if user opened a shared link (e.g., ?trip_id=XYZ)
                const params = new URLSearchParams(window.location.search);
                const sharedId = params.get('trip_id');
                
                if (sharedId) {
                    // Wait for trips to load or fetch specific doc
                    const docRef = doc(db, "trips", sharedId);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists()) {
                        activeTrip.value = { id: docSnap.id, ...docSnap.data() };
                        currentView.value = 'details';
                    }
                }
            });

            return {
                currentView, activeTab, trips, activeTrip,
                newExpense, newItem,
                upcomingTripsCount, totalGlobalBudget, activeTripBudget, splitAmount,
                selectTrip, createTrip, shareTrip,
                addExpense, removeExpense, addItem, removeItem, addActivity, removeActivity
            };
        }
    }).mount('#app');
</script>

</body>
</html>


  